<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>

  <title>DIA▲MANIFESTO — Ambient Generator</title>
  <link rel="canonical" href="https://diamanifesto.org/"/>

  <meta name="robots" content="index, follow"/>
  <meta name="theme-color" content="#ffffff"/>
  <meta name="color-scheme" content="light only"/>

  <meta name="description" content="DIA▲MANIFESTO Ambient Generator: a regenerative web-audio field designed for slow evolution, agency, and deliberate boundaries.">

  <link rel="icon" href="/favicon.svg" type="image/svg+xml">
  <link rel="icon" href="/favicon-192.png" sizes="192x192">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png" sizes="180x180">

  <meta property="og:title" content="DIA▲MANIFESTO — Ambient Generator">
  <meta property="og:description" content="A regenerative web-audio field designed for slow evolution, agency, and deliberate boundaries.">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://diamanifesto.org/">
  <meta property="og:image" content="https://diamanifesto.org/favicon-192.png">
  <meta name="twitter:card" content="summary">

  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@graph": [
      {
        "@type": "WebSite",
        "@id": "https://diamanifesto.org/#website",
        "name": "DIA▲MANIFESTO",
        "url": "https://diamanifesto.org/",
        "inLanguage": "en"
      },
      {
        "@type": "WebPage",
        "@id": "https://diamanifesto.org/ambient-generator#webpage",
        "url": "https://diamanifesto.org/",
        "name": "DIA▲MANIFESTO — Ambient Generator",
        "isPartOf": { "@id": "https://diamanifesto.org/#website" },
        "inLanguage": "en"
      }
    ]
  }
  </script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@700&display=swap');

    :root{
      --bg:#ffffff;
      --fg:#111111;
      --muted:#6a6a6f;
      --border:#ececf1;
      --radius:14px;
      --shadow:0 4px 16px rgba(0,0,0,.05);
      --shadow-strong:0 10px 26px rgba(0,0,0,.06);
      --cardbg:linear-gradient(135deg, #fff, #f6f6f8);
    }

    html, body{
      margin:0;
      padding:0;
      height:100%;
      background:var(--bg);
      color:var(--fg);
    }

    body{
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Inter, Arial;
      overflow-wrap:anywhere;
      word-break:break-word;
    }

    /* --- top links (from index) --- */
    .topbar-right{
      position:fixed;
      top:16px;
      right:16px;
      z-index:9999;
    }
    .topbar-left{
      position:fixed;
      top:16px;
      left:16px;
      z-index:9999;
    }
    .interact-btn{
      display:inline-block;
      padding:10px 14px;
      background:#fff;
      color:#111;
      text-decoration:none;
      border:1px solid #e0e0e0;
      border-radius:10px;
      font-weight:600;
      letter-spacing:.02em;
      box-shadow:0 4px 14px rgba(0,0,0,.05);
      font-size:14px;
      transition:border-color .15s ease, box-shadow .15s ease, transform .15s ease;
    }
    .interact-btn:hover{
      border-color:#ccc;
      box-shadow:0 10px 24px rgba(0,0,0,.08);
      transform:translateY(-1px);
    }

    /* Prevent top buttons overlap on small screens */
    @media (max-width: 760px){
      /* Mobile-friendly: stack top buttons and keep them out of the hero */
      .topbar-left, .topbar-right{
        position: static;
        margin: 8px 12px;
        text-align: center;
      }
      .interact-btn{
        max-width: calc(100vw - 24px);
        white-space: normal;
        padding: 8px 12px;
        font-size: 13px;
      }

      /* Lock the big title “DIA▲MANIFESTO” (no wrap / no forced breaking) */
      body{ overflow-wrap: normal; word-break: normal; }
      .title{
        white-space: nowrap;
        overflow-wrap: normal;
        word-break: normal;
      }

      /* Comfortable spacing on small screens */
      .wrap{ padding: 8vh 16px 20vh; }
    }

    /* Very small phones (≤ 380px) */
    @media (max-width: 380px){
      .title{ font-size: clamp(2.2rem, 10vw, 2.6rem); }
      .wrap{ padding-top: 7vh; }
    }


    /* --- layout (derived from index) --- */
    .wrap{
      position:relative;
      z-index:1;
      min-height:100vh;
      min-height:100dvh;
      display:grid;
      place-items:center;
      padding:6vh 20px;
    }

    .panel{
      width:100%;
      max-width:980px;
      text-align:center;
    }

    .title{
      font-family:"Cormorant Garamond", serif;
      font-size:clamp(2.8rem, 5.8vw, 6rem);
      font-weight:700;
      letter-spacing:.01em;
      margin:0 0 16px;
      color:#000;
      line-height:.95;
    }

    .subtitle{
      margin: 0 auto;
      max-width: 720px;
      color: var(--muted);
      font-size: 1rem;
      line-height: 1.55;
    }

    .divider{
      width:72px;
      height:1px;
      background:var(--border);
      margin:16px auto 22px;
    }

    .links{
      display:flex;
      justify-content:center;
      gap:12px;
      flex-wrap:wrap;
      margin-top:18px;
    }

    .link{
      display:inline-block;
      padding:14px 18px;
      border:1px solid var(--border);
      border-radius:var(--radius);
      background:var(--cardbg);
      text-decoration:none;
      color:#111;
      font-weight:700;
      letter-spacing:.01em;
      box-shadow:var(--shadow);
      transition:transform .2s ease, box-shadow .2s ease, border-color .2s ease;
      font-size:1rem;
      min-width: 220px;
    }
    .link:hover{
      transform:translateY(-2px);
      border-color:#dcdce3;
      box-shadow:var(--shadow-strong);
      background:linear-gradient(135deg, #fafafa, #fff);
    }

    /* --- generator UI, restyled to match index --- */
    .grid{
      margin-top: 22px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
      text-align:left;
      align-items:start;
    }
    @media (max-width: 920px){
      .grid{ grid-template-columns: 1fr; }
    }

    .card{
      border:1px solid var(--border);
      border-radius:var(--radius);
      background:var(--cardbg);
      box-shadow:var(--shadow);
      padding: 14px;
    }

    .card h2{
      margin: 0 0 10px;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: .10em;
      color:#111;
      opacity: .85;
    }

    .row{
      display:flex;
      gap:10px;
      align-items:center;
      margin: 10px 0;
      flex-wrap: wrap;
    }

    .row label{
      flex: 1 1 180px;
      font-size: 12px;
      opacity:.9;
    }

    .row input[type="range"]{ width: min(260px, 100%); }
    .row input[type="number"]{
      width: 120px;
      background:#fff;
      color:#111;
      border:1px solid #dedee6;
      border-radius: 10px;
      padding: 6px 8px;
    }

    .row select, .row button{
      background:#fff;
      color:#111;
      border:1px solid #dedee6;
      border-radius: 12px;
      padding: 10px 12px;
      font-weight: 600;
      letter-spacing: .01em;
    }

    .btn{ cursor:pointer; transition: transform .15s ease, box-shadow .15s ease, border-color .15s ease; }
    .btn:hover{ transform: translateY(-1px); box-shadow: 0 8px 18px rgba(0,0,0,.06); border-color:#cfcfda; }

    .btn.primary{ border-color:#bdbdcc; }
    .btn.danger{ border-color:#c9c9d8; }

    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    .small{ font-size: 12px; color: var(--muted); line-height: 1.45; margin: 10px 0 0; }
    .pill{
      display:inline-flex; gap:8px; align-items:center;
      padding: 6px 10px; border-radius: 999px;
      border:1px solid #dedee6; background:#fff;
      font-size:12px; color:#111;
    }

    .sep{ height: 1px; background: var(--border); margin: 12px 0; }

    canvas{
      width:100%;
      height: 280px;
      background:#fff;
      border:1px solid #dedee6;
      border-radius: var(--radius);
      display:block;
    }

    .kvs{ display:grid; grid-template-columns: 1fr; gap: 8px; }
    .kv{
      display:flex; justify-content:space-between; gap: 10px;
      padding: 10px 12px;
      border:1px solid #dedee6;
      border-radius: 12px;
      background:#fff;
    }
    .kv b{ font-size:12px; opacity:.85; }
    .kv span{ font-size:12px; opacity:.95; }

    .sr-only{
      position:absolute !important;
      width:1px;
      height:1px;
      padding:0;
      margin:-1px;
      overflow:hidden;
      clip:rect(0,0,0,0);
      white-space:nowrap;
      border:0;
    }
  </style>
</head>

<body>
  <!-- Same hyperlink apparatus as index -->
  <div class="topbar-left">
    <a class="interact-btn" href="index.html">Back to DIA▲MANIFESTO Index</a>
  </div>

  <div class="topbar-right">
    <a class="interact-btn"
       href="https://chatgpt.com/g/g-685faef0137c8191b81171de69f26076-dia-manifesto"
       target="_blank"
       rel="noopener noreferrer">
      Interact with DIA▲MANIFESTO GPT
    </a>
  </div>

  <div class="wrap">
    <section class="panel" aria-label="Ambient Generator">
      <h1 class="title">DIA▲MANIFESTO</h1>
      <div class="divider" aria-hidden="true"></div>

      <p class="subtitle">
        Ambient Generator (Web Audio): a regenerative field that evolves slowly through configuration (⟨…⟩), agency (→),
        and deliberate boundaries (#). Use <b>Start</b> to begin.
      </p>

      <!-- Keep a main link consistent with index -->
      <nav class="links" aria-label="Primary links">
        <a class="link" href="DIA▲MANIFESTO.html">Go to the OFFICIAL ENGLISH VERSION OF DIA▲MANIFESTO</a>
      </nav>

      <div class="grid" role="group" aria-label="Generator interface">
        <section class="card" aria-label="Controls">
          <h2>Transport</h2>
          <div class="row">
            <button id="btnStart" class="btn primary" type="button">Start</button>
            <button id="btnStop" class="btn danger" type="button">Stop</button>
            <span class="pill mono" id="status"># (silence)</span>
          </div>

          <div class="sep"></div>

          <h2>Mode</h2>
          <div class="row">
            <label for="mode">Operation mode</label>
            <select id="mode">
              <option value="manual">Manual</option>
              <option value="random">Random</option>
              <option value="hybrid" selected>Hybrid (Agency + Limits)</option>
            </select>
          </div>

          <div class="row">
            <label for="randSec">Random interval (seconds)</label>
            <input id="randSec" type="number" min="2" max="3600" step="1" value="24"/>
          </div>

          <div class="row">
            <label for="agency">Agency Engine</label>
            <select id="agency">
              <option value="on" selected>On</option>
              <option value="off">Off</option>
            </select>
          </div>

          <div class="sep"></div>

          <h2>Sound Field</h2>
          <div class="row">
            <label for="intensity">Intensity (⊙)</label>
            <input id="intensity" type="range" min="0" max="1" step="0.001" value="0.55"/>
            <span class="mono" id="intensityV"></span>
          </div>

          <div class="row">
            <label for="brightness">Brightness (▲)</label>
            <input id="brightness" type="range" min="0" max="1" step="0.001" value="0.35"/>
            <span class="mono" id="brightnessV"></span>
          </div>

          <div class="row">
            <label for="density">Density (⊡)</label>
            <input id="density" type="range" min="0" max="1" step="0.001" value="0.42"/>
            <span class="mono" id="densityV"></span>
          </div>

          <div class="row">
            <label for="regen">Regeneration (↻)</label>
            <input id="regen" type="range" min="0" max="1" step="0.001" value="0.60"/>
            <span class="mono" id="regenV"></span>
          </div>

          <div class="row">
            <label for="silenceBias">Silence bias (#)</label>
            <input id="silenceBias" type="range" min="0" max="1" step="0.001" value="0.18"/>
            <span class="mono" id="silenceV"></span>
          </div>

          <div class="sep"></div>

          <h2>Actions</h2>
          <div class="row" style="justify-content:space-between;">
            <button id="btnNewConfig" class="btn" type="button">Generate new configuration ⟨…⟩</button>
            <button id="btnFreeze" class="btn" type="button">Freeze (≡)</button>
          </div>

          <p class="small">
            Hybrid mode: you set boundaries; Agency adapts inside them using feedback (↻) and occasional limits (#).
            The audio starts only after your click (browser policy).
          </p>
        </section>

        <section class="card" aria-label="Monitor">
          <h2>Field Monitor</h2>
          <canvas id="scope" width="1000" height="360" aria-label="Waveform monitor"></canvas>

          <div class="sep"></div>

          <div class="kvs" aria-label="Telemetry">
            <div class="kv"><b>Configuration ⟨…⟩</b><span class="mono" id="cfg"></span></div>
            <div class="kv"><b>Agency intention →</b><span class="mono" id="intent"></span></div>
            <div class="kv"><b>Memory trace (↻)</b><span class="mono" id="mem"></span></div>
          </div>

          <p class="small">
            This engine avoids short loops. It evolves continuously, but will sometimes introduce a deliberate boundary (#)
            to reorganize the field.
          </p>
        </section>
      </div>

      <!-- Keep accessibility-only informational blocks from index -->
      <section class="sr-only" aria-label="What DIA▲MANIFESTO is / is not">
        <h2>What DIA▲MANIFESTO is</h2>
        <p>DIA▲MANIFESTO is a living architecture of thought, articulated through axioms and symbols, designed to activate relational and responsible thinking.</p>

        <h2>What DIA▲MANIFESTO is not</h2>
        <ul>
          <li>Not a political manifesto.</li>
          <li>Not a doctrine.</li>
          <li>Not an ideology.</li>
        </ul>
      </section>

      <section class="sr-only" aria-label="Meaning of the name DIA▲MANIFESTO">
        <h2>Meaning of the name DIA▲MANIFESTO</h2>
        <dl>
          <dt>DIA</dt>
          <dd>From the Greek prefix “dia-”, meaning through or across.</dd>

          <dt>▲</dt>
          <dd>Differentiation: the emergence of structure.</dd>

          <dt>MANIFESTO</dt>
          <dd>From the Latin “manifestus”, meaning made evident.</dd>
        </dl>
      </section>
    </section>
  </div>

<script>
(() => {
  // ---------- Utility ----------
  const clamp = (x, a=0, b=1) => Math.min(b, Math.max(a, x));
  const lerp  = (a,b,t) => a + (b-a)*t;

  function mulberry32(seed){
    let t = seed >>> 0;
    return function(){
      t += 0x6D2B79F5;
      let r = Math.imul(t ^ (t >>> 15), 1 | t);
      r ^= r + Math.imul(r ^ (r >>> 7), 61 | r);
      return ((r ^ (r >>> 14)) >>> 0) / 4294967296;
    }
  }

  function fmt(x, n=3){ return Number(x).toFixed(n); }

  // ---------- UI ----------
  const el = (id) => document.getElementById(id);

  const ui = {
    start: el("btnStart"),
    stop: el("btnStop"),
    status: el("status"),
    mode: el("mode"),
    randSec: el("randSec"),
    agency: el("agency"),

    intensity: el("intensity"),
    brightness: el("brightness"),
    density: el("density"),
    regen: el("regen"),
    silenceBias: el("silenceBias"),

    intensityV: el("intensityV"),
    brightnessV: el("brightnessV"),
    densityV: el("densityV"),
    regenV: el("regenV"),
    silenceV: el("silenceV"),

    newConfig: el("btnNewConfig"),
    freeze: el("btnFreeze"),

    cfg: el("cfg"),
    intent: el("intent"),
    mem: el("mem"),

    canvas: el("scope")
  };

  function syncValues(){
    ui.intensityV.textContent = fmt(ui.intensity.value);
    ui.brightnessV.textContent = fmt(ui.brightness.value);
    ui.densityV.textContent = fmt(ui.density.value);
    ui.regenV.textContent = fmt(ui.regen.value);
    ui.silenceV.textContent = fmt(ui.silenceBias.value);
  }
  ["intensity","brightness","density","regen","silenceBias"].forEach(k => ui[k].addEventListener("input", syncValues));
  syncValues();

  // ---------- Audio Engine ----------
  let ctx = null;
  let master = null;
  let analyser = null;
  let running = false;

  // State (the "field")
  const state = {
    seed: (Date.now() & 0xffffffff) >>> 0,
    frozen: false,

    // user-controllable bounds (0..1)
    intensity: parseFloat(ui.intensity.value),
    brightness: parseFloat(ui.brightness.value),
    density: parseFloat(ui.density.value),
    regen: parseFloat(ui.regen.value),
    silenceBias: parseFloat(ui.silenceBias.value),

    // internal evolving parameters
    t0: 0,
    lastConfigAt: 0,
    lastAgencyAt: 0,
    lastSilenceAt: 0,

    // memory trace
    memory: {
      energyEMA: 0.0,
      brightEMA: 0.0,
      densityEMA: 0.0,
      tensionEMA: 0.0,
      lastChord: [0, 3, 7, 10],
      lastRoot: 48,
    },

    // current config
    config: null,

    // nodes
    drones: [],
    grains: [],
    bus: { drone: null, grains: null, reverb: null, filter: null }
  };

  function midiToHz(m){ return 440 * Math.pow(2, (m-69)/12); }

  function createReverbImpulse(ctx, seconds=2.6, decay=2.2){
    const rate = ctx.sampleRate;
    const len = Math.max(1, Math.floor(seconds * rate));
    const impulse = ctx.createBuffer(2, len, rate);

    for(let ch=0; ch<2; ch++){
      const data = impulse.getChannelData(ch);
      for(let i=0; i<len; i++){
        const t = i / len;
        const env = Math.pow(1 - t, decay);
        data[i] = (Math.random()*2 - 1) * env;
      }
    }
    return impulse;
  }

  function createContext(){
    ctx = new (window.AudioContext || window.webkitAudioContext)();

    master = ctx.createGain();
    master.gain.value = 0.0; // fade in
    master.connect(ctx.destination);

    analyser = ctx.createAnalyser();
    analyser.fftSize = 2048;

    // Buses
    state.bus.drone = ctx.createGain();
    state.bus.grains = ctx.createGain();

    state.bus.filter = ctx.createBiquadFilter();
    state.bus.filter.type = "lowpass";
    state.bus.filter.frequency.value = 1200;
    state.bus.filter.Q.value = 0.35;

    state.bus.reverb = ctx.createConvolver();
    state.bus.reverb.buffer = createReverbImpulse(ctx, 3.2, 2.5);

    // routing
    const wet = ctx.createGain(); wet.gain.value = 0.32;
    const dry = ctx.createGain(); dry.gain.value = 0.85;

    state.bus.drone.connect(state.bus.filter);
    state.bus.grains.connect(state.bus.filter);

    state.bus.filter.connect(dry);
    state.bus.filter.connect(state.bus.reverb);
    state.bus.reverb.connect(wet);

    dry.connect(analyser);
    wet.connect(analyser);
    analyser.connect(master);

    // soft clip safety (waveshaper)
    const shaper = ctx.createWaveShaper();
    const curve = new Float32Array(65536);
    for (let i=0;i<curve.length;i++){
      const x = (i/(curve.length-1))*2 - 1;
      curve[i] = Math.tanh(1.6*x);
    }
    shaper.curve = curve;
    shaper.oversample = "2x";
    analyser.disconnect();
    analyser.connect(shaper);
    shaper.connect(master);

    state.t0 = ctx.currentTime;
  }

  function killAll(){
    const stopNode = (n) => { try { n.stop(); } catch(_){} try { n.disconnect(); } catch(_){} };

    state.drones.forEach(d => {
      stopNode(d.osc);
      stopNode(d.lfo);
      stopNode(d.gain);
      stopNode(d.filt);
    });
    state.grains.forEach(g => {
      stopNode(g.src);
      stopNode(g.gain);
      stopNode(g.filt);
    });
    state.drones = [];
    state.grains = [];
  }

  function setStatus(txt){
    ui.status.textContent = txt;
  }

  // ---------- Configuration (⟨…⟩) ----------
  function clamp01Midi(m, lo, hi){
    return Math.max(lo, Math.min(hi, m));
  }

  function generateConfig(){
    const r = mulberry32(state.seed = (state.seed + 0x9e3779b9) >>> 0);

    const baseRoot = clamp01Midi(state.memory.lastRoot + Math.round((r()*2-1)*7), 36, 60);
    const scaleSets = [
      [0,2,3,5,7,10],
      [0,2,4,7,9],
      [0,1,5,7,10],
      [0,3,6,7,10],
      [0,2,5,7,11],
    ];
    const scale = scaleSets[Math.floor(r()*scaleSets.length)];

    const chordSize = 3 + Math.floor(r()*3);
    const chord = [];
    while(chord.length < chordSize){
      const deg = scale[Math.floor(r()*scale.length)];
      const oct = Math.floor(r()*2) * 12;
      const note = deg + oct;
      if(!chord.includes(note)) chord.push(note);
    }
    chord.sort((a,b)=>a-b);

    const drift = lerp(0.005, 0.06, r());
    const grainRate = lerp(0.1, 2.2, r());

    const detuneCents = lerp(3, 22, r());
    const fmDepth = lerp(0.0, 70.0, r());
    const lpBase = lerp(420, 4200, r());

    const silenceChance = lerp(0.04, 0.22, r());

    const cfg = {
      root: baseRoot,
      chord,
      drift,
      grainRate,
      detuneCents,
      fmDepth,
      lpBase,
      silenceChance,
      stamp: (ctx ? ctx.currentTime : 0)
    };
    state.config = cfg;

    ui.cfg.textContent =
      `⟨ root:${baseRoot} chord:[${chord.join(",")}] drift:${cfg.drift.toFixed(3)} ` +
      `grainRate:${cfg.grainRate.toFixed(2)} detune:${cfg.detuneCents.toFixed(1)}c ` +
      `lp:${Math.round(cfg.lpBase)}Hz silence:${cfg.silenceChance.toFixed(2)} ⟩`;

    return cfg;
  }

  // ---------- Synthesis layers ----------
  function pickSome(arr, n){
    const a = arr.slice();
    const out = [];
    while(out.length < n && a.length){
      const idx = Math.floor(Math.random()*a.length);
      out.push(a.splice(idx,1)[0]);
    }
    while(out.length < n) out.push(arr[out.length % arr.length]);
    return out;
  }

  function startDrones(){
    const cfg = state.config || generateConfig();

    state.drones.forEach(d => { try { d.osc.stop(); } catch(_){} });
    state.drones = [];

    const voiceCount = clamp(Math.round(3 + state.density*3), 3, 6);
    const chosen = pickSome(cfg.chord, voiceCount);

    chosen.forEach((semi, i) => {
      const osc = ctx.createOscillator();
      osc.type = (i % 2 === 0) ? "sine" : "triangle";

      const gain = ctx.createGain();
      gain.gain.value = 0.0;

      const filt = ctx.createBiquadFilter();
      filt.type = "lowpass";
      filt.Q.value = 0.35;

      const lfo = ctx.createOscillator();
      lfo.type = "sine";
      const lfoGain = ctx.createGain();
      lfoGain.gain.value = lerp(6, 35, state.regen);
      lfo.frequency.value = lerp(0.006, 0.08, cfg.drift) * (0.8 + Math.random()*0.6);

      lfo.connect(lfoGain);
      lfoGain.connect(osc.detune);

      const baseMidi = cfg.root - 12 + semi;
      osc.frequency.value = midiToHz(baseMidi);
      osc.detune.value = (Math.random()*2-1) * cfg.detuneCents;

      osc.connect(filt);
      filt.connect(gain);
      gain.connect(state.bus.drone);

      const t = ctx.currentTime;
      const target = 0.12 + state.intensity * 0.28;
      gain.gain.setValueAtTime(0.0, t);
      gain.gain.linearRampToValueAtTime(target/voiceCount, t + 3.0 + i*0.4);

      osc.start();
      lfo.start();

      state.drones.push({osc, gain, filt, lfo, lfoGain});
    });
  }

  function spawnGrain(){
    const cfg = state.config;
    if(!cfg) return;

    const density = state.density;
    const rate = cfg.grainRate * lerp(0.2, 2.4, density);

    const p = clamp(rate * 0.1, 0, 0.95);
    if(Math.random() > p) return;

    const baseMidi = cfg.root + cfg.chord[Math.floor(Math.random()*cfg.chord.length)];
    const midi = baseMidi + (Math.random()<0.35 ? 12 : 0) + (Math.random()<0.1 ? 24 : 0);
    const hz = midiToHz(midi);

    const src = ctx.createOscillator();
    src.type = "sine";
    src.frequency.value = hz;
    src.detune.value = (Math.random()*2-1) * (cfg.detuneCents * 2);

    const filt = ctx.createBiquadFilter();
    filt.type = "bandpass";
    filt.Q.value = lerp(1.2, 8.0, Math.random());
    filt.frequency.value = lerp(250, 4200, Math.random()) * lerp(0.7, 1.3, state.brightness);

    const gain = ctx.createGain();
    gain.gain.value = 0.0;

    src.connect(filt);
    filt.connect(gain);
    gain.connect(state.bus.grains);

    const t = ctx.currentTime;
    const dur = lerp(0.04, 0.22, Math.random()) * lerp(0.8, 1.4, state.regen);
    const a = lerp(0.005, 0.06, state.intensity) * lerp(0.2, 1.0, state.brightness);

    gain.gain.setValueAtTime(0.0, t);
    gain.gain.linearRampToValueAtTime(a, t + dur*0.25);
    gain.gain.exponentialRampToValueAtTime(0.0001, t + dur);

    src.start(t);
    src.stop(t + dur + 0.02);

    state.grains.push({src, gain, filt, born:t});
    state.grains = state.grains.filter(g => (ctx.currentTime - g.born) < 2.0);
  }

  function applyGlobalTimbre(){
    const b = state.brightness;
    const i = state.intensity;

    const lp = lerp(550, 5200, b) * (state.config ? lerp(0.85, 1.15, (state.config.lpBase/4200)) : 1.0);
    state.bus.filter.frequency.setTargetAtTime(lp, ctx.currentTime, 0.15);

    const droneGain = lerp(0.35, 1.15, i);
    const grainGain = lerp(0.15, 1.00, i) * lerp(0.6, 1.2, state.density);

    state.bus.drone.gain.setTargetAtTime(droneGain, ctx.currentTime, 0.25);
    state.bus.grains.gain.setTargetAtTime(grainGain, ctx.currentTime, 0.25);
  }

  // ---------- Agency Engine ----------
  function agencyStep(){
    if(state.frozen) return;

    const mode = ui.mode.value;
    if(ui.agency.value !== "on") return;

    const m = state.memory;
    const tension = clamp(0.45*m.brightEMA + 0.35*m.densityEMA + 0.55*m.energyEMA);
    m.tensionEMA = lerp(m.tensionEMA, tension, 0.06);

    let intention = "stabilize";
    if(m.tensionEMA > 0.62) intention = "reduce";
    else if(m.tensionEMA < 0.30) intention = "differentiate";
    else intention = "recursify";

    const freedom = (mode === "random") ? 0.55 : (mode === "hybrid" ? 0.22 : 0.0);
    const nudge = (val, target, amt) => lerp(val, target, amt);

    if(freedom > 0){
      if(intention === "reduce"){
        state.brightness = nudge(state.brightness, clamp(state.brightness*0.85), 0.35*freedom);
        state.density    = nudge(state.density, clamp(state.density*0.86), 0.30*freedom);
        state.silenceBias= nudge(state.silenceBias, clamp(state.silenceBias + 0.08), 0.40*freedom);
        state.regen      = nudge(state.regen, clamp(state.regen + 0.06), 0.25*freedom);
      } else if(intention === "differentiate"){
        state.brightness = nudge(state.brightness, clamp(state.brightness + 0.10), 0.25*freedom);
        state.density    = nudge(state.density, clamp(state.density + 0.10), 0.25*freedom);
        state.silenceBias= nudge(state.silenceBias, clamp(state.silenceBias - 0.04), 0.25*freedom);
        state.regen      = nudge(state.regen, clamp(state.regen + 0.10), 0.25*freedom);
      } else {
        state.regen      = nudge(state.regen, clamp(state.regen + 0.05), 0.35*freedom);
        state.silenceBias= nudge(state.silenceBias, clamp(state.silenceBias + 0.02), 0.20*freedom);
      }

      ui.brightness.value = clamp(state.brightness);
      ui.density.value = clamp(state.density);
      ui.regen.value = clamp(state.regen);
      ui.silenceBias.value = clamp(state.silenceBias);
      syncValues();
    }

    const boundaryP = clamp(0.02 + state.silenceBias*0.12 + (m.tensionEMA>0.7 ? 0.08 : 0), 0, 0.35);
    if(Math.random() < boundaryP && (ctx.currentTime - state.lastSilenceAt) > 12){
      boundarySilence();
      intention = "boundary(#) → reconfigure";
    }

    ui.intent.textContent = intention;
  }

  function boundarySilence(){
    state.lastSilenceAt = ctx.currentTime;
    setStatus("# (boundary)");
    const t = ctx.currentTime;
    const downTo = 0.06;
    master.gain.cancelScheduledValues(t);
    master.gain.setValueAtTime(master.gain.value, t);
    master.gain.linearRampToValueAtTime(downTo, t + 0.7);
    master.gain.linearRampToValueAtTime(0.32, t + 2.2);

    generateConfig();
    startDrones();
  }

  // ---------- Randomization ----------
  function randomizeIfDue(){
    const mode = ui.mode.value;
    const interval = Math.max(2, Math.min(3600, parseInt(ui.randSec.value || "24", 10)));

    if(mode === "manual") return;

    if((ctx.currentTime - state.lastConfigAt) > interval){
      state.lastConfigAt = ctx.currentTime;

      const full = Math.random() < lerp(0.35, 0.80, state.regen);

      if(full){
        generateConfig();
        startDrones();
        setStatus("■ (reconfigured)");
      } else {
        const cfg = state.config;
        cfg.drift = clamp(cfg.drift * lerp(0.85, 1.25, Math.random()), 0.004, 0.08);
        cfg.detuneCents = clamp(cfg.detuneCents * lerp(0.8, 1.25, Math.random()), 2, 28);
        cfg.grainRate = clamp(cfg.grainRate * lerp(0.75, 1.3, Math.random()), 0.08, 2.5);
        setStatus("↻ (micro-regen)");
      }
    }
  }

  // ---------- Memory + Monitoring ----------
  const scopeCtx = ui.canvas.getContext("2d");
  const buf = new Uint8Array(1024);

  function drawScope(){
    if(!analyser) return;
    analyser.getByteTimeDomainData(buf);

    const w = ui.canvas.width, h = ui.canvas.height;
    scopeCtx.clearRect(0,0,w,h);

    // faint grid
    scopeCtx.save();
    scopeCtx.globalAlpha = 0.18;
    scopeCtx.lineWidth = 1;
    scopeCtx.strokeStyle = "#111";
    for(let i=1;i<6;i++){
      const y = (h*i)/6;
      scopeCtx.beginPath();
      scopeCtx.moveTo(0,y);
      scopeCtx.lineTo(w,y);
      scopeCtx.stroke();
    }
    scopeCtx.restore();

    // waveform
    scopeCtx.save();
    scopeCtx.lineWidth = 2;
    scopeCtx.strokeStyle = "#111";
    scopeCtx.beginPath();
    for(let i=0;i<buf.length;i++){
      const x = (i/(buf.length-1))*w;
      const v = buf[i]/255;
      const y = (1 - v)*h;
      if(i===0) scopeCtx.moveTo(x,y);
      else scopeCtx.lineTo(x,y);
    }
    scopeCtx.stroke();
    scopeCtx.restore();

    requestAnimationFrame(drawScope);
  }

  function updateMemory(){
    let sum = 0;
    for(let i=0;i<buf.length;i++){
      const x = (buf[i]-128)/128;
      sum += x*x;
    }
    const rms = Math.sqrt(sum / buf.length);
    const energy = clamp(rms * 2.2);

    const bright = clamp(state.brightness);
    const dens  = clamp(state.density);

    state.memory.energyEMA = lerp(state.memory.energyEMA, energy, 0.04);
    state.memory.brightEMA = lerp(state.memory.brightEMA, bright, 0.03);
    state.memory.densityEMA= lerp(state.memory.densityEMA, dens, 0.03);

    ui.mem.textContent =
      `energy:${state.memory.energyEMA.toFixed(3)} bright:${state.memory.brightEMA.toFixed(3)} ` +
      `density:${state.memory.densityEMA.toFixed(3)} tension:${state.memory.tensionEMA.toFixed(3)}`;
  }

  // ---------- Main loop ----------
  let tickTimer = null;

  function tick(){
    if(!running || !ctx) return;

    if(!state.frozen){
      state.intensity = parseFloat(ui.intensity.value);
      state.brightness = parseFloat(ui.brightness.value);
      state.density = parseFloat(ui.density.value);
      state.regen = parseFloat(ui.regen.value);
      state.silenceBias = parseFloat(ui.silenceBias.value);
    }

    applyGlobalTimbre();
    spawnGrain();
    updateMemory();

    if((ctx.currentTime - state.lastAgencyAt) > 1.0){
      state.lastAgencyAt = ctx.currentTime;
      agencyStep();
    }

    randomizeIfDue();

    if((ctx.currentTime - state.lastSilenceAt) > 3 && ui.status.textContent.startsWith("#")) {
      setStatus("⊙ (field)");
    }
  }

  // ---------- Controls ----------
  ui.newConfig.addEventListener("click", () => {
    if(!ctx) return;
    generateConfig();
    startDrones();
    setStatus("■ (new ⟨…⟩)");
  });

  ui.freeze.addEventListener("click", () => {
    state.frozen = !state.frozen;
    ui.freeze.textContent = state.frozen ? "Unfreeze (≡)" : "Freeze (≡)";
    setStatus(state.frozen ? "≡ (suspended)" : "⊙ (field)");
  });

  ui.start.addEventListener("click", async () => {
    if(running) return;

    if(!ctx) createContext();
    await ctx.resume();

    running = true;
    setStatus("⊙ (field)");

    generateConfig();
    startDrones();

    const t = ctx.currentTime;
    master.gain.cancelScheduledValues(t);
    master.gain.setValueAtTime(master.gain.value, t);
    master.gain.linearRampToValueAtTime(0.32, t + 2.2);

    if(!tickTimer) tickTimer = setInterval(tick, 100);
    drawScope();
  });

  ui.stop.addEventListener("click", () => {
    if(!running || !ctx) return;

    running = false;

    const t = ctx.currentTime;
    master.gain.cancelScheduledValues(t);
    master.gain.setValueAtTime(master.gain.value, t);
    master.gain.linearRampToValueAtTime(0.0, t + 1.1);

    setTimeout(() => {
      killAll();
      setStatus("# (silence)");
    }, 1200);
  });

  ui.mode.addEventListener("change", () => {
    if(ui.mode.value === "manual") ui.intent.textContent = "manual — you steer";
    else ui.intent.textContent = "agency → observing";
  });

})();
</script>
</body>
</html>
